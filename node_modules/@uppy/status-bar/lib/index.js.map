{"version":3,"sources":["index.js"],"names":["UIPlugin","require","getSpeed","getBytesRemaining","getTextDirection","statusBarStates","StatusBarUI","locale","module","exports","StatusBar","constructor","uppy","opts","startUpload","recoveredState","getState","emit","undefined","upload","catch","id","title","type","defaultLocale","defaultOptions","target","hideUploadButton","hideRetryButton","hidePauseResumeButton","hideCancelButton","showProgressDetails","hideAfterFinish","doneButtonHandler","i18nInit","render","bind","install","state","capabilities","files","allowNewUpload","totalProgress","error","newFiles","startedFiles","completeFiles","inProgressNotPausedFiles","isUploadStarted","isAllComplete","isAllErrored","isAllPaused","isUploadInProgress","isSomeGhost","getObjectOfFilesPerState","newFilesOrRecovered","Object","values","totalETA","getTotalETA","resumableUploads","supportsUploadProgress","uploadProgress","totalSize","totalUploadedSize","forEach","file","progress","bytesTotal","bytesUploaded","uploadState","getUploadingState","complete","length","numUploads","i18n","isTargetDOMEl","onMount","element","el","direction","dir","mount","uninstall","unmount","VERSION","getTotalSpeed","totalSpeed","totalBytesRemaining","reduce","total","Math","round","STATE_ERROR","STATE_COMPLETE","STATE_WAITING","fileIDs","keys","i","uploadStarted","uploadComplete","STATE_UPLOADING","preprocess","STATE_PREPROCESSING","postprocess","STATE_POSTPROCESSING"],"mappings":"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","sourcesContent":["const { UIPlugin } = require('@uppy/core')\nconst getSpeed = require('@uppy/utils/lib/getSpeed')\nconst getBytesRemaining = require('@uppy/utils/lib/getBytesRemaining')\nconst getTextDirection = require('@uppy/utils/lib/getTextDirection')\nconst statusBarStates = require('./StatusBarStates')\nconst StatusBarUI = require('./StatusBar')\n\nconst locale = require('./locale.js')\n\n/**\n * StatusBar: renders a status bar with upload/pause/resume/cancel/retry buttons,\n * progress percentage and time remaining.\n */\nmodule.exports = class StatusBar extends UIPlugin {\n  // eslint-disable-next-line global-require\n  static VERSION = require('../package.json').version\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.id = this.opts.id || 'StatusBar'\n    this.title = 'StatusBar'\n    this.type = 'progressindicator'\n\n    this.defaultLocale = locale\n\n    // set default options\n    const defaultOptions = {\n      target: 'body',\n      hideUploadButton: false,\n      hideRetryButton: false,\n      hidePauseResumeButton: false,\n      hideCancelButton: false,\n      showProgressDetails: false,\n      hideAfterFinish: true,\n      doneButtonHandler: null,\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n\n    this.i18nInit()\n\n    this.render = this.render.bind(this)\n    this.install = this.install.bind(this)\n  }\n\n  startUpload = () => {\n    const { recoveredState } = this.uppy.getState()\n\n    if (recoveredState) {\n      this.uppy.emit('restore-confirmed')\n      return undefined\n    }\n\n    return this.uppy.upload().catch(() => {\n      // Error logged in Core\n    })\n  }\n\n  render (state) {\n    const {\n      capabilities,\n      files,\n      allowNewUpload,\n      totalProgress,\n      error,\n      recoveredState,\n    } = state\n\n    const {\n      newFiles,\n      startedFiles,\n      completeFiles,\n      inProgressNotPausedFiles,\n\n      isUploadStarted,\n      isAllComplete,\n      isAllErrored,\n      isAllPaused,\n      isUploadInProgress,\n      isSomeGhost,\n    } = this.uppy.getObjectOfFilesPerState()\n\n    // If some state was recovered, we want to show Upload button/counter\n    // for all the files, because in this case it’s not an Upload button,\n    // but “Confirm Restore Button”\n    const newFilesOrRecovered = recoveredState\n      ? Object.values(files)\n      : newFiles\n    const totalETA = getTotalETA(inProgressNotPausedFiles)\n    const resumableUploads = !!capabilities.resumableUploads\n    const supportsUploadProgress = capabilities.uploadProgress !== false\n\n    let totalSize = 0\n    let totalUploadedSize = 0\n\n    startedFiles.forEach((file) => {\n      totalSize += file.progress.bytesTotal || 0\n      totalUploadedSize += file.progress.bytesUploaded || 0\n    })\n\n    return StatusBarUI({\n      error,\n      uploadState: getUploadingState(\n        error,\n        isAllComplete,\n        recoveredState,\n        state.files || {},\n      ),\n      allowNewUpload,\n      totalProgress,\n      totalSize,\n      totalUploadedSize,\n      isAllComplete: false,\n      isAllPaused,\n      isAllErrored,\n      isUploadStarted,\n      isUploadInProgress,\n      isSomeGhost,\n      recoveredState,\n      complete: completeFiles.length,\n      newFiles: newFilesOrRecovered.length,\n      numUploads: startedFiles.length,\n      totalETA,\n      files,\n      i18n: this.i18n,\n      uppy: this.uppy,\n      startUpload: this.startUpload,\n      doneButtonHandler: this.opts.doneButtonHandler,\n      resumableUploads,\n      supportsUploadProgress,\n      showProgressDetails: this.opts.showProgressDetails,\n      hideUploadButton: this.opts.hideUploadButton,\n      hideRetryButton: this.opts.hideRetryButton,\n      hidePauseResumeButton: this.opts.hidePauseResumeButton,\n      hideCancelButton: this.opts.hideCancelButton,\n      hideAfterFinish: this.opts.hideAfterFinish,\n      isTargetDOMEl: this.isTargetDOMEl,\n    })\n  }\n\n  onMount () {\n    // Set the text direction if the page has not defined one.\n    const element = this.el\n    const direction = getTextDirection(element)\n    if (!direction) {\n      element.dir = 'ltr'\n    }\n  }\n\n  install () {\n    const { target } = this.opts\n    if (target) {\n      this.mount(target, this)\n    }\n  }\n\n  uninstall () {\n    this.unmount()\n  }\n}\n\nfunction getTotalSpeed (files) {\n  let totalSpeed = 0\n  files.forEach((file) => {\n    totalSpeed += getSpeed(file.progress)\n  })\n  return totalSpeed\n}\n\nfunction getTotalETA (files) {\n  const totalSpeed = getTotalSpeed(files)\n  if (totalSpeed === 0) {\n    return 0\n  }\n\n  const totalBytesRemaining = files.reduce((total, file) => {\n    return total + getBytesRemaining(file.progress)\n  }, 0)\n\n  return Math.round((totalBytesRemaining / totalSpeed) * 10) / 10\n}\n\nfunction getUploadingState (error, isAllComplete, recoveredState, files) {\n  if (error && !isAllComplete) {\n    return statusBarStates.STATE_ERROR\n  }\n\n  if (isAllComplete) {\n    return statusBarStates.STATE_COMPLETE\n  }\n\n  if (recoveredState) {\n    return statusBarStates.STATE_WAITING\n  }\n\n  let state = statusBarStates.STATE_WAITING\n  const fileIDs = Object.keys(files)\n  for (let i = 0; i < fileIDs.length; i++) {\n    const { progress } = files[fileIDs[i]]\n    // If ANY files are being uploaded right now, show the uploading state.\n    if (progress.uploadStarted && !progress.uploadComplete) {\n      return statusBarStates.STATE_UPLOADING\n    }\n    // If files are being preprocessed AND postprocessed at this time, we show the\n    // preprocess state. If any files are being uploaded we show uploading.\n    if (progress.preprocess && state !== statusBarStates.STATE_UPLOADING) {\n      state = statusBarStates.STATE_PREPROCESSING\n    }\n    // If NO files are being preprocessed or uploaded right now, but some files are\n    // being postprocessed, show the postprocess state.\n    if (\n      progress.postprocess\n      && state !== statusBarStates.STATE_UPLOADING\n      && state !== statusBarStates.STATE_PREPROCESSING\n    ) {\n      state = statusBarStates.STATE_POSTPROCESSING\n    }\n  }\n  return state\n}\n"]}