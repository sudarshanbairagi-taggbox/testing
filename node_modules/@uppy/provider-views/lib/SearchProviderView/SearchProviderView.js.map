{"version":3,"sources":["SearchProviderView.js"],"names":["h","require","SearchInput","Browser","LoaderView","Header","CloseWrapper","View","module","exports","SearchProviderView","constructor","plugin","opts","defaultOptions","viewType","showTitles","showFilter","showBreadcrumbs","search","bind","triggerSearchInput","addFile","handleScroll","donePicking","render","setPluginState","isInputMode","files","folders","directories","filterInput","currentSelection","searchTerm","tearDown","clearSelection","query","getPluginState","sharedHandler","loaderWrapper","provider","res","handleError","event","nextPageQuery","shouldHandleScroll","isHandlingScroll","response","error","promises","map","file","Promise","all","state","viewOptions","didFirstRender","preFirstRender","targetViewOptions","loading","isChecked","toggleCheckbox","filterItems","hasInput","browserProps","done","cancel","cancelPicking","headerComponent","i18n","uppy","title","pluginIcon","icon","uppyFiles","getFiles","validateRestrictions","VERSION","items","forEach","item","push","searchedFor"],"mappings":"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","sourcesContent":["const { h } = require('preact')\nconst SearchInput = require('./InputView')\nconst Browser = require('../Browser')\nconst LoaderView = require('../Loader')\nconst Header = require('./Header')\nconst CloseWrapper = require('../CloseWrapper')\nconst View = require('../View')\n\n/**\n * Class to easily generate generic views for Provider plugins\n */\nmodule.exports = class SearchProviderView extends View {\n  static VERSION = require('../../package.json').version\n\n  /**\n   * @param {object} plugin instance of the plugin\n   * @param {object} opts\n   */\n  constructor (plugin, opts) {\n    super(plugin, opts)\n\n    // set default options\n    const defaultOptions = {\n      viewType: 'grid',\n      showTitles: false,\n      showFilter: false,\n      showBreadcrumbs: false,\n    }\n\n    // merge default options with the ones set by user\n    this.opts = { ...defaultOptions, ...opts }\n\n    // Logic\n    this.search = this.search.bind(this)\n    this.triggerSearchInput = this.triggerSearchInput.bind(this)\n    this.addFile = this.addFile.bind(this)\n    this.handleScroll = this.handleScroll.bind(this)\n    this.donePicking = this.donePicking.bind(this)\n\n    // Visual\n    this.render = this.render.bind(this)\n\n    // Set default state for the plugin\n    this.plugin.setPluginState({\n      isInputMode: true,\n      files: [],\n      folders: [],\n      directories: [],\n      filterInput: '',\n      currentSelection: [],\n      searchTerm: null,\n    })\n  }\n\n  tearDown () {\n    // Nothing.\n  }\n\n  clearSelection () {\n    this.plugin.setPluginState({\n      currentSelection: [],\n      isInputMode: true,\n      files: [],\n      searchTerm: null,\n    })\n  }\n\n  #updateFilesAndInputMode (res, files) {\n    this.nextPageQuery = res.nextPageQuery\n    res.items.forEach((item) => { files.push(item) })\n    this.plugin.setPluginState({\n      isInputMode: false,\n      files,\n      searchTerm: res.searchedFor,\n    })\n  }\n\n  search (query) {\n    const { searchTerm } = this.plugin.getPluginState()\n    if (query && query === searchTerm) {\n      // no need to search again as this is the same as the previous search\n      return\n    }\n\n    return this.sharedHandler.loaderWrapper(\n      this.provider.search(query),\n      (res) => {\n        this.#updateFilesAndInputMode(res, [])\n      },\n      this.handleError,\n    )\n  }\n\n  triggerSearchInput () {\n    this.plugin.setPluginState({ isInputMode: true })\n  }\n\n  async handleScroll (event) {\n    const query = this.nextPageQuery || null\n\n    if (this.shouldHandleScroll(event) && query) {\n      this.isHandlingScroll = true\n\n      try {\n        const { files, searchTerm } = this.plugin.getPluginState()\n        const response = await this.provider.search(searchTerm, query)\n\n        this.#updateFilesAndInputMode(response, files)\n      } catch (error) {\n        this.handleError(error)\n      } finally {\n        this.isHandlingScroll = false\n      }\n    }\n  }\n\n  donePicking () {\n    const { currentSelection } = this.plugin.getPluginState()\n    const promises = currentSelection.map((file) => this.addFile(file))\n\n    this.sharedHandler.loaderWrapper(Promise.all(promises), () => {\n      this.clearSelection()\n    }, () => {})\n  }\n\n  render (state, viewOptions = {}) {\n    const { didFirstRender, isInputMode, searchTerm } = this.plugin.getPluginState()\n\n    if (!didFirstRender) {\n      this.preFirstRender()\n    }\n\n    const targetViewOptions = { ...this.opts, ...viewOptions }\n    const { files, folders, filterInput, loading, currentSelection } = this.plugin.getPluginState()\n    const { isChecked, toggleCheckbox, filterItems } = this.sharedHandler\n    const hasInput = filterInput !== ''\n\n    const browserProps = {\n      isChecked,\n      toggleCheckbox,\n      currentSelection,\n      files: hasInput ? filterItems(files) : files,\n      folders: hasInput ? filterItems(folders) : folders,\n      handleScroll: this.handleScroll,\n      done: this.donePicking,\n      cancel: this.cancelPicking,\n      headerComponent: Header({\n        search: this.search,\n        i18n: this.plugin.uppy.i18n,\n        searchTerm,\n      }),\n      title: this.plugin.title,\n      viewType: targetViewOptions.viewType,\n      showTitles: targetViewOptions.showTitles,\n      showFilter: targetViewOptions.showFilter,\n      showBreadcrumbs: targetViewOptions.showBreadcrumbs,\n      pluginIcon: this.plugin.icon,\n      i18n: this.plugin.uppy.i18n,\n      uppyFiles: this.plugin.uppy.getFiles(),\n      validateRestrictions: (...args) => this.plugin.uppy.validateRestrictions(...args),\n    }\n\n    if (loading) {\n      return (\n        <CloseWrapper onUnmount={this.clearSelection}>\n          <LoaderView i18n={this.plugin.uppy.i18n} />\n        </CloseWrapper>\n      )\n    }\n\n    if (isInputMode) {\n      return (\n        <CloseWrapper onUnmount={this.clearSelection}>\n          <SearchInput\n            search={this.search}\n            i18n={this.plugin.uppy.i18n}\n          />\n        </CloseWrapper>\n      )\n    }\n\n    return (\n      <CloseWrapper onUnmount={this.clearSelection}>\n        <Browser {...browserProps} />\n      </CloseWrapper>\n    )\n  }\n}\n"]}