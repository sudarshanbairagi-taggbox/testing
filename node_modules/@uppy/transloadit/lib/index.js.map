{"version":3,"sources":["index.js"],"names":["hasProperty","require","ErrorWithCause","BasePlugin","Tus","Assembly","Client","AssemblyOptions","AssemblyWatcher","locale","defaultGetAssemblyOptions","file","options","params","signature","fields","sendErrorToConsole","originalErr","err","error","cause","console","COMPANION","ALLOWED_COMPANION_PATTERN","TL_COMPANION","module","exports","Transloadit","constructor","uppy","opts","rawFile","getFile","id","transloadit","assembly","assemblies","getPluginState","client","addFile","catch","log","emit","uploadsAssemblies","assemblyIDs","Object","values","flat","cancelPromises","map","assemblyID","getAssembly","Promise","all","setData","pluginData","savedState","previousAssemblies","keys","length","restoreState","files","results","status","entries","uploads","forEach","uploadedFile","state","stepName","result","original_id","localId","push","setPluginState","restoreAssemblies","uploadID","fileIDsInUpload","flatMap","getAssemblyFiles","allAssemblyIDs","updateAssemblies","activeAssemblies","update","restored","resolve","then","fileIDs","filteredFileIDs","filter","fileID","mode","message","i18n","createAssembly","importFromUploadURLs","assemblyOptions","build","createdAssemblies","assembly_id","closeSocketConnections","close","addResultData","incompleteFiles","completedFiles","watcher","assemblyWatchers","promise","submitError","startsWith","endpoint","originalRequest","getUnderlyingObject","responseURL","type","title","defaultLocale","defaultOptions","service","errorReporting","waitForEncoding","waitForMetadata","alwaysRunAssembly","getAssemblyOptions","limit","retryDelays","i18nInit","hasCustomAssemblyOptions","validateParams","create","install","addPreProcessor","addPostProcessor","on","use","storeFingerprintForResuming","useFastRemoteRetry","metaFields","capabilities","getState","setState","individualCancellation","uninstall","removePreProcessor","removePostProcessor","off","getFiles","VERSION","list","addPluginVersion","pluginName","versionName","plugin","getPlugin","join","meta","assembly_url","filename","name","fieldname","tus","tus_url","addRequestId","remote","test","companionUrl","newHost","companion_url","replace","path","url","newFile","assign","expectedFiles","newAssembly","updatedFiles","fileRemovedHandler","fileRemoved","reason","reserveFile","i","uploadURL","tus_upload_url","uploadUrl","is_tus_file","size","undefined","assemblyId","entry","assembly_ssl_url","getAssemblyStatus","finalStatus","cancelAssembly","newStatus","ok","connect","COMPANION_PATTERN"],"mappings":"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","sourcesContent":["const hasProperty = require('@uppy/utils/lib/hasProperty')\nconst ErrorWithCause = require('@uppy/utils/lib/ErrorWithCause')\nconst BasePlugin = require('@uppy/core/lib/BasePlugin')\nconst Tus = require('@uppy/tus')\nconst Assembly = require('./Assembly')\nconst Client = require('./Client')\nconst AssemblyOptions = require('./AssemblyOptions')\nconst AssemblyWatcher = require('./AssemblyWatcher')\n\nconst locale = require('./locale')\n\nfunction defaultGetAssemblyOptions (file, options) {\n  return {\n    params: options.params,\n    signature: options.signature,\n    fields: options.fields,\n  }\n}\n\nconst sendErrorToConsole = originalErr => err => {\n  const error = new ErrorWithCause('Failed to send error to the client', { cause: err })\n  // eslint-ignore-next-line no-console\n  console.error(error, originalErr)\n}\n\nconst COMPANION = 'https://api2.transloadit.com/companion'\n// Regex matching acceptable postMessage() origins for authentication feedback from companion.\nconst ALLOWED_COMPANION_PATTERN = /\\.transloadit\\.com$/\n// Regex used to check if a Companion address is run by Transloadit.\nconst TL_COMPANION = /https?:\\/\\/api2(?:-\\w+)?\\.transloadit\\.com\\/companion/\n\n/**\n * Upload files to Transloadit using Tus.\n */\nmodule.exports = class Transloadit extends BasePlugin {\n  static VERSION = require('../package.json').version // eslint-disable-line global-require\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = this.opts.id || 'Transloadit'\n    this.title = 'Transloadit'\n\n    this.defaultLocale = locale\n\n    const defaultOptions = {\n      service: 'https://api2.transloadit.com',\n      errorReporting: true,\n      waitForEncoding: false,\n      waitForMetadata: false,\n      alwaysRunAssembly: false,\n      importFromUploadURLs: false,\n      signature: null,\n      params: null,\n      fields: {},\n      getAssemblyOptions: defaultGetAssemblyOptions,\n      limit: 20,\n      retryDelays: [7_000, 10_000, 15_000, 20_000],\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n\n    this.i18nInit()\n\n    const hasCustomAssemblyOptions = this.opts.getAssemblyOptions !== defaultOptions.getAssemblyOptions\n    if (this.opts.params) {\n      AssemblyOptions.validateParams(this.opts.params)\n    } else if (!hasCustomAssemblyOptions) {\n      // Throw the same error that we'd throw if the `params` returned from a\n      // `getAssemblyOptions()` function is null.\n      AssemblyOptions.validateParams(null)\n    }\n\n    this.client = new Client({\n      service: this.opts.service,\n      client: this.#getClientVersion(),\n      errorReporting: this.opts.errorReporting,\n    })\n    // Contains Assembly instances for in-progress Assemblies.\n    this.activeAssemblies = {}\n    // Contains a mapping of uploadID to AssemblyWatcher\n    this.assemblyWatchers = {}\n    // Contains a file IDs that have completed postprocessing before the upload\n    // they belong to has entered the postprocess stage.\n    this.completedFiles = Object.create(null)\n  }\n\n  #getClientVersion () {\n    const list = [\n      `uppy-core:${this.uppy.constructor.VERSION}`,\n      `uppy-transloadit:${this.constructor.VERSION}`,\n      `uppy-tus:${Tus.VERSION}`,\n    ]\n\n    const addPluginVersion = (pluginName, versionName) => {\n      const plugin = this.uppy.getPlugin(pluginName)\n      if (plugin) {\n        list.push(`${versionName}:${plugin.constructor.VERSION}`)\n      }\n    }\n\n    if (this.opts.importFromUploadURLs) {\n      addPluginVersion('XHRUpload', 'uppy-xhr-upload')\n      addPluginVersion('AwsS3', 'uppy-aws-s3')\n      addPluginVersion('AwsS3Multipart', 'uppy-aws-s3-multipart')\n    }\n\n    addPluginVersion('Dropbox', 'uppy-dropbox')\n    addPluginVersion('Box', 'uppy-box')\n    addPluginVersion('Facebook', 'uppy-facebook')\n    addPluginVersion('GoogleDrive', 'uppy-google-drive')\n    addPluginVersion('Instagram', 'uppy-instagram')\n    addPluginVersion('OneDrive', 'uppy-onedrive')\n    addPluginVersion('Zoom', 'uppy-zoom')\n    addPluginVersion('Url', 'uppy-url')\n\n    return list.join(',')\n  }\n\n  /**\n   * Attach metadata to files to configure the Tus plugin to upload to Transloadit.\n   * Also use Transloadit's Companion\n   *\n   * See: https://github.com/tus/tusd/wiki/Uploading-to-Transloadit-using-tus#uploading-using-tus\n   *\n   * @param {object} file\n   * @param {object} status\n   */\n  #attachAssemblyMetadata (file, status) {\n    // Add the metadata parameters Transloadit needs.\n    const meta = {\n      ...file.meta,\n      assembly_url: status.assembly_url,\n      filename: file.name,\n      fieldname: 'file',\n    }\n    // Add Assembly-specific Tus endpoint.\n    const tus = {\n      ...file.tus,\n      endpoint: status.tus_url,\n      // Include X-Request-ID headers for better debugging.\n      addRequestId: true,\n    }\n\n    // Set Companion location. We only add this, if 'file' has the attribute\n    // remote, because this is the criteria to identify remote files.\n    // We only replace the hostname for Transloadit's companions, so that\n    // people can also self-host them while still using Transloadit for encoding.\n    let { remote } = file\n\n    if (file.remote && TL_COMPANION.test(file.remote.companionUrl)) {\n      const newHost = status.companion_url\n        .replace(/\\/$/, '')\n      const path = file.remote.url\n        .replace(file.remote.companionUrl, '')\n        .replace(/^\\//, '')\n\n      remote = {\n        ...file.remote,\n        companionUrl: newHost,\n        url: `${newHost}/${path}`,\n      }\n    }\n\n    // Store the Assembly ID this file is in on the file under the `transloadit` key.\n    const newFile = {\n      ...file,\n      transloadit: {\n        assembly: status.assembly_id,\n      },\n    }\n    // Only configure the Tus plugin if we are uploading straight to Transloadit (the default).\n    if (!this.opts.importFromUploadURLs) {\n      Object.assign(newFile, { meta, tus, remote })\n    }\n    return newFile\n  }\n\n  #createAssembly (fileIDs, uploadID, options) {\n    this.uppy.log('[Transloadit] Create Assembly')\n\n    return this.client.createAssembly({\n      params: options.params,\n      fields: options.fields,\n      expectedFiles: fileIDs.length,\n      signature: options.signature,\n    }).then((newAssembly) => {\n      const assembly = new Assembly(newAssembly)\n      const { status } = assembly\n      const assemblyID = status.assembly_id\n\n      const { assemblies, uploadsAssemblies } = this.getPluginState()\n      this.setPluginState({\n        // Store the Assembly status.\n        assemblies: {\n          ...assemblies,\n          [assemblyID]: status,\n        },\n        // Store the list of Assemblies related to this upload.\n        uploadsAssemblies: {\n          ...uploadsAssemblies,\n          [uploadID]: [\n            ...uploadsAssemblies[uploadID],\n            assemblyID,\n          ],\n        },\n      })\n\n      const { files } = this.uppy.getState()\n      const updatedFiles = {}\n      fileIDs.forEach((id) => {\n        updatedFiles[id] = this.#attachAssemblyMetadata(this.uppy.getFile(id), status)\n      })\n      this.uppy.setState({\n        files: {\n          ...files,\n          ...updatedFiles,\n        },\n      })\n      const fileRemovedHandler = (fileRemoved, reason) => {\n        if (reason === 'cancel-all') {\n          assembly.close()\n          this.uppy.off(fileRemovedHandler)\n        } else if (fileRemoved.id in updatedFiles) {\n          delete updatedFiles[fileRemoved.id]\n          if (Object.keys(updatedFiles).length === 0) {\n            assembly.close()\n            this.uppy.off(fileRemovedHandler)\n          }\n        }\n      }\n      this.uppy.on('file-removed', fileRemovedHandler)\n\n      this.uppy.emit('transloadit:assembly-created', status, fileIDs)\n\n      this.uppy.log(`[Transloadit] Created Assembly ${assemblyID}`)\n      return assembly\n    }).catch((err) => {\n      throw new ErrorWithCause(`${this.i18n('creatingAssemblyFailed')}: ${err.message}`, { cause: err })\n    })\n  }\n\n  #createAssemblyWatcher (assemblyID, fileIDs, uploadID) {\n  // AssemblyWatcher tracks completion states of all Assemblies in this upload.\n    const watcher = new AssemblyWatcher(this.uppy, assemblyID)\n\n    watcher.on('assembly-complete', (id) => {\n      const files = this.getAssemblyFiles(id)\n      files.forEach((file) => {\n        this.completedFiles[file.id] = true\n        this.uppy.emit('postprocess-complete', file)\n      })\n    })\n\n    watcher.on('assembly-error', (id, error) => {\n      // Clear postprocessing state for all our files.\n      const files = this.getAssemblyFiles(id)\n      files.forEach((file) => {\n      // TODO Maybe make a postprocess-error event here?\n        this.uppy.emit('upload-error', file, error)\n\n        this.uppy.emit('postprocess-complete', file)\n      })\n    })\n\n    this.assemblyWatchers[uploadID] = watcher\n  }\n\n  #shouldWaitAfterUpload () {\n    return this.opts.waitForEncoding || this.opts.waitForMetadata\n  }\n\n  /**\n   * Used when `importFromUploadURLs` is enabled: reserves all files in\n   * the Assembly.\n   */\n  #reserveFiles (assembly, fileIDs) {\n    return Promise.all(fileIDs.map((fileID) => {\n      const file = this.uppy.getFile(fileID)\n      return this.client.reserveFile(assembly.status, file)\n    }))\n  }\n\n  /**\n   * Used when `importFromUploadURLs` is enabled: adds files to the Assembly\n   * once they have been fully uploaded.\n   */\n  #onFileUploadURLAvailable = (rawFile) => {\n    const file = this.uppy.getFile(rawFile.id)\n    if (!file || !file.transloadit || !file.transloadit.assembly) {\n      return\n    }\n\n    const { assemblies } = this.getPluginState()\n    const assembly = assemblies[file.transloadit.assembly]\n\n    this.client.addFile(assembly, file).catch((err) => {\n      this.uppy.log(err)\n      this.uppy.emit('transloadit:import-error', assembly, file.id, err)\n    })\n  }\n\n  #findFile (uploadedFile) {\n    const files = this.uppy.getFiles()\n    for (let i = 0; i < files.length; i++) {\n      const file = files[i]\n      // Completed file upload.\n      if (file.uploadURL === uploadedFile.tus_upload_url) {\n        return file\n      }\n      // In-progress file upload.\n      if (file.tus && file.tus.uploadUrl === uploadedFile.tus_upload_url) {\n        return file\n      }\n      if (!uploadedFile.is_tus_file) {\n        // Fingers-crossed check for non-tus uploads, eg imported from S3.\n        if (file.name === uploadedFile.name && file.size === uploadedFile.size) {\n          return file\n        }\n      }\n    }\n    return undefined\n  }\n\n  #onFileUploadComplete (assemblyId, uploadedFile) {\n    const state = this.getPluginState()\n    const file = this.#findFile(uploadedFile)\n    if (!file) {\n      this.uppy.log('[Transloadit] Couldn’t file the file, it was likely removed in the process')\n      return\n    }\n    this.setPluginState({\n      files: {\n        ...state.files,\n        [uploadedFile.id]: {\n          assembly: assemblyId,\n          id: file.id,\n          uploadedFile,\n        },\n      },\n    })\n    this.uppy.emit('transloadit:upload', uploadedFile, this.getAssembly(assemblyId))\n  }\n\n  /**\n   * Callback when a new Assembly result comes in.\n   *\n   * @param {string} assemblyId\n   * @param {string} stepName\n   * @param {object} result\n   */\n  #onResult (assemblyId, stepName, result) {\n    const state = this.getPluginState()\n    const file = state.files[result.original_id]\n    // The `file` may not exist if an import robot was used instead of a file upload.\n    result.localId = file ? file.id : null // eslint-disable-line no-param-reassign\n\n    const entry = {\n      result,\n      stepName,\n      id: result.id,\n      assembly: assemblyId,\n    }\n\n    this.setPluginState({\n      results: [...state.results, entry],\n    })\n    this.uppy.emit('transloadit:result', stepName, result, this.getAssembly(assemblyId))\n  }\n\n  /**\n   * When an Assembly has finished processing, get the final state\n   * and emit it.\n   *\n   * @param {object} status\n   */\n  #onAssemblyFinished (status) {\n    const url = status.assembly_ssl_url\n    this.client.getAssemblyStatus(url).then((finalStatus) => {\n      const assemblyId = finalStatus.assembly_id\n      const state = this.getPluginState()\n      this.setPluginState({\n        assemblies: {\n          ...state.assemblies,\n          [assemblyId]: finalStatus,\n        },\n      })\n      this.uppy.emit('transloadit:complete', finalStatus)\n    })\n  }\n\n  async #cancelAssembly (assembly) {\n    await this.client.cancelAssembly(assembly)\n    // TODO bubble this through AssemblyWatcher so its event handlers can clean up correctly\n    this.uppy.emit('transloadit:assembly-cancelled', assembly)\n  }\n\n  /**\n   * When all files are removed, cancel in-progress Assemblies.\n   */\n  #onCancelAll = () => {\n    const { uploadsAssemblies } = this.getPluginState()\n\n    const assemblyIDs = Object.values(uploadsAssemblies).flat(1)\n\n    const cancelPromises = assemblyIDs.map((assemblyID) => {\n      const assembly = this.getAssembly(assemblyID)\n      return this.#cancelAssembly(assembly)\n    })\n\n    Promise.all(cancelPromises).catch((err) => {\n      this.uppy.log(err)\n    })\n  }\n\n  /**\n   * Custom state serialization for the Golden Retriever plugin.\n   * It will pass this back to the `_onRestored` function.\n   *\n   * @param {Function} setData\n   */\n  #getPersistentData = (setData) => {\n    const { assemblies, uploadsAssemblies } = this.getPluginState()\n\n    setData({\n      [this.id]: {\n        assemblies,\n        uploadsAssemblies,\n      },\n    })\n  }\n\n  #onRestored = (pluginData) => {\n    const savedState = pluginData && pluginData[this.id] ? pluginData[this.id] : {}\n    const previousAssemblies = savedState.assemblies || {}\n    const uploadsAssemblies = savedState.uploadsAssemblies || {}\n\n    if (Object.keys(uploadsAssemblies).length === 0) {\n      // Nothing to restore.\n      return\n    }\n\n    // Convert loaded Assembly statuses to a Transloadit plugin state object.\n    const restoreState = (assemblies) => {\n      const files = {}\n      const results = []\n      for (const [id, status] of Object.entries(assemblies))  {\n        status.uploads.forEach((uploadedFile) => {\n          const file = this.#findFile(uploadedFile)\n          files[uploadedFile.id] = {\n            id: file.id,\n            assembly: id,\n            uploadedFile,\n          }\n        })\n\n        const state = this.getPluginState()\n        Object.keys(status.results).forEach((stepName) => {\n          for (const result of status.results[stepName]) {\n            const file = state.files[result.original_id]\n            result.localId = file ? file.id : null\n            results.push({\n              id: result.id,\n              result,\n              stepName,\n              assembly: id,\n            })\n          }\n        })\n      }\n\n      this.setPluginState({\n        assemblies,\n        files,\n        results,\n        uploadsAssemblies,\n      })\n    }\n\n    // Set up the Assembly instances and AssemblyWatchers for existing Assemblies.\n    const restoreAssemblies = () => {\n      // eslint-disable-next-line no-shadow\n      const { assemblies, uploadsAssemblies } = this.getPluginState()\n\n      // Set up the assembly watchers again for all the ongoing uploads.\n      Object.keys(uploadsAssemblies).forEach((uploadID) => {\n        const assemblyIDs = uploadsAssemblies[uploadID]\n        const fileIDsInUpload = assemblyIDs.flatMap((assemblyID) => {\n          return this.getAssemblyFiles(assemblyID).map((file) => file.id)\n        })\n        this.#createAssemblyWatcher(assemblyIDs, fileIDsInUpload, uploadID)\n      })\n\n      const allAssemblyIDs = Object.keys(assemblies)\n      allAssemblyIDs.forEach((id) => {\n        const assembly = new Assembly(assemblies[id])\n        this.#connectAssembly(assembly)\n      })\n    }\n\n    // Force-update all Assemblies to check for missed events.\n    const updateAssemblies = () => {\n      const { assemblies } = this.getPluginState()\n      return Promise.all(\n        Object.keys(assemblies).map((id) => {\n          return this.activeAssemblies[id].update()\n        }),\n      )\n    }\n\n    // Restore all Assembly state.\n    this.restored = Promise.resolve().then(() => {\n      restoreState(previousAssemblies)\n      restoreAssemblies()\n      return updateAssemblies()\n    })\n\n    this.restored.then(() => {\n      this.restored = null\n    })\n  }\n\n  #connectAssembly (assembly) {\n    const { status } = assembly\n    const id = status.assembly_id\n    this.activeAssemblies[id] = assembly\n\n    // Sync local `assemblies` state\n    assembly.on('status', (newStatus) => {\n      const { assemblies } = this.getPluginState()\n      this.setPluginState({\n        assemblies: {\n          ...assemblies,\n          [id]: newStatus,\n        },\n      })\n    })\n\n    assembly.on('upload', (file) => {\n      this.#onFileUploadComplete(id, file)\n    })\n    assembly.on('error', (error) => {\n      error.assembly = assembly.status // eslint-disable-line no-param-reassign\n      this.uppy.emit('transloadit:assembly-error', assembly.status, error)\n    })\n\n    assembly.on('executing', () => {\n      this.uppy.emit('transloadit:assembly-executing', assembly.status)\n    })\n\n    if (this.opts.waitForEncoding) {\n      assembly.on('result', (stepName, result) => {\n        this.#onResult(id, stepName, result)\n      })\n    }\n\n    if (this.opts.waitForEncoding) {\n      assembly.on('finished', () => {\n        this.#onAssemblyFinished(assembly.status)\n      })\n    } else if (this.opts.waitForMetadata) {\n      assembly.on('metadata', () => {\n        this.#onAssemblyFinished(assembly.status)\n      })\n    }\n\n    // No need to connect to the socket if the Assembly has completed by now.\n    if (assembly.ok === 'ASSEMBLY_COMPLETE') {\n      return assembly\n    }\n\n    assembly.connect()\n    return assembly\n  }\n\n  #prepareUpload = (fileIDs, uploadID) => {\n    // Only use files without errors\n    const filteredFileIDs = fileIDs.filter((file) => !file.error)\n\n    const files = filteredFileIDs.map(fileID => {\n      const file = this.uppy.getFile(fileID)\n      this.uppy.emit('preprocess-progress', file, {\n        mode: 'indeterminate',\n        message: this.i18n('creatingAssembly'),\n      })\n      return file\n    })\n\n    // eslint-disable-next-line no-shadow\n    const createAssembly = async ({ fileIDs, options }) => {\n      try {\n        const assembly = await this.#createAssembly(fileIDs, uploadID, options)\n        if (this.opts.importFromUploadURLs) {\n          await this.#reserveFiles(assembly, fileIDs)\n        }\n        fileIDs.forEach((fileID) => {\n          const file = this.uppy.getFile(fileID)\n          this.uppy.emit('preprocess-complete', file)\n        })\n        return assembly\n      } catch (err)  {\n        fileIDs.forEach((fileID) => {\n          const file = this.uppy.getFile(fileID)\n          // Clear preprocessing state when the Assembly could not be created,\n          // otherwise the UI gets confused about the lingering progress keys\n          this.uppy.emit('preprocess-complete', file)\n          this.uppy.emit('upload-error', file, err)\n        })\n        throw err\n      }\n    }\n\n    const { uploadsAssemblies } = this.getPluginState()\n    this.setPluginState({\n      uploadsAssemblies: {\n        ...uploadsAssemblies,\n        [uploadID]: [],\n      },\n    })\n\n    const assemblyOptions = new AssemblyOptions(files, this.opts)\n\n    return assemblyOptions.build()\n      .then((assemblies) => Promise.all(assemblies.map(createAssembly)))\n      .then((createdAssemblies) => {\n        const assemblyIDs = createdAssemblies.map(assembly => assembly.status.assembly_id)\n        this.#createAssemblyWatcher(assemblyIDs, filteredFileIDs, uploadID)\n        return Promise.all(createdAssemblies.map(assembly => this.#connectAssembly(assembly)))\n      })\n      // If something went wrong before any Assemblies could be created,\n      // clear all processing state.\n      .catch((err) => {\n        files.forEach((file) => {\n          this.uppy.emit('preprocess-complete', file)\n          this.uppy.emit('upload-error', file, err)\n        })\n        throw err\n      })\n  }\n\n  #afterUpload = (fileIDs, uploadID) => {\n    const files = fileIDs.map(fileID => this.uppy.getFile(fileID))\n    // Only use files without errors\n    const filteredFileIDs = files.filter((file) => !file.error).map(file => file.id)\n\n    const state = this.getPluginState()\n\n    // If we're still restoring state, wait for that to be done.\n    if (this.restored) {\n      return this.restored.then(() => {\n        return this.#afterUpload(filteredFileIDs, uploadID)\n      })\n    }\n\n    const assemblyIDs = state.uploadsAssemblies[uploadID]\n\n    const closeSocketConnections = () => {\n      assemblyIDs.forEach((assemblyID) => {\n        const assembly = this.activeAssemblies[assemblyID]\n        assembly.close()\n        delete this.activeAssemblies[assemblyID]\n      })\n    }\n\n    // If we don't have to wait for encoding metadata or results, we can close\n    // the socket immediately and finish the upload.\n    if (!this.#shouldWaitAfterUpload()) {\n      closeSocketConnections()\n      const assemblies = assemblyIDs.map((id) => this.getAssembly(id))\n      this.uppy.addResultData(uploadID, { transloadit: assemblies })\n      return Promise.resolve()\n    }\n\n    // If no Assemblies were created for this upload, we also do not have to wait.\n    // There's also no sockets or anything to close, so just return immediately.\n    if (assemblyIDs.length === 0) {\n      this.uppy.addResultData(uploadID, { transloadit: [] })\n      return Promise.resolve()\n    }\n\n    const incompleteFiles = files.filter(file => !hasProperty(this.completedFiles, file.id))\n    incompleteFiles.forEach((file) => {\n      this.uppy.emit('postprocess-progress', file, {\n        mode: 'indeterminate',\n        message: this.i18n('encoding'),\n      })\n    })\n\n    const watcher = this.assemblyWatchers[uploadID]\n    return watcher.promise.then(() => {\n      closeSocketConnections()\n\n      const assemblies = assemblyIDs.map((id) => this.getAssembly(id))\n\n      // Remove the Assembly ID list for this upload,\n      // it's no longer going to be used anywhere.\n      const uploadsAssemblies = { ...this.getPluginState().uploadsAssemblies }\n      delete uploadsAssemblies[uploadID]\n      this.setPluginState({ uploadsAssemblies })\n\n      this.uppy.addResultData(uploadID, {\n        transloadit: assemblies,\n      })\n    })\n  }\n\n  #closeAssemblyIfExists = (assemblyID) => {\n    this.activeAssemblies[assemblyID]?.close()\n  }\n\n  #onError = (err = null, uploadID) => {\n    const state = this.getPluginState()\n    const assemblyIDs = state.uploadsAssemblies[uploadID]\n    assemblyIDs?.forEach(this.#closeAssemblyIfExists)\n\n    this.client.submitError(err)\n      // if we can't report the error that sucks\n      .catch(sendErrorToConsole(err))\n  }\n\n  #onTusError = (file, err) => {\n    this.#closeAssemblyIfExists(file.transloadit?.assembly)\n    if (err?.message?.startsWith('tus: ')) {\n      const endpoint = err.originalRequest?.getUnderlyingObject()?.responseURL\n      this.client.submitError(err, { endpoint, type: 'TUS_ERROR' })\n        // if we can't report the error that sucks\n        .catch(sendErrorToConsole(err))\n    }\n  }\n\n  install () {\n    this.uppy.addPreProcessor(this.#prepareUpload)\n    this.uppy.addPostProcessor(this.#afterUpload)\n\n    // We may need to close socket.io connections on error.\n    this.uppy.on('error', this.#onError)\n\n    // Handle cancellation.\n    this.uppy.on('cancel-all', this.#onCancelAll)\n\n    // For error reporting.\n    this.uppy.on('upload-error', this.#onTusError)\n\n    if (this.opts.importFromUploadURLs) {\n      // No uploader needed when importing; instead we take the upload URL from an existing uploader.\n      this.uppy.on('upload-success', this.#onFileUploadURLAvailable)\n    } else {\n      this.uppy.use(Tus, {\n        // Disable tus-js-client fingerprinting, otherwise uploading the same file at different times\n        // will upload to an outdated Assembly, and we won't get socket events for it.\n        //\n        // To resume a Transloadit upload, we need to reconnect to the websocket, and the state that's\n        // required to do that is not saved by tus-js-client's fingerprinting. We need the tus URL,\n        // the Assembly URL, and the WebSocket URL, at least. We also need to know _all_ the files that\n        // were added to the Assembly, so we can properly complete it. All that state is handled by\n        // Golden Retriever. So, Golden Retriever is required to do resumability with the Transloadit plugin,\n        // and we disable Tus's default resume implementation to prevent bad behaviours.\n        storeFingerprintForResuming: false,\n        // Disable Companion's retry optimisation; we need to change the endpoint on retry\n        // so it can't just reuse the same tus.Upload instance server-side.\n        useFastRemoteRetry: false,\n        // Only send Assembly metadata to the tus endpoint.\n        metaFields: ['assembly_url', 'filename', 'fieldname'],\n        // Pass the limit option to @uppy/tus\n        limit: this.opts.limit,\n        retryDelays: this.opts.retryDelays,\n      })\n    }\n\n    this.uppy.on('restore:get-data', this.#getPersistentData)\n    this.uppy.on('restored', this.#onRestored)\n\n    this.setPluginState({\n      // Contains Assembly status objects, indexed by their ID.\n      assemblies: {},\n      // Contains arrays of Assembly IDs, indexed by the upload ID that they belong to.\n      uploadsAssemblies: {},\n      // Contains file data from Transloadit, indexed by their Transloadit-assigned ID.\n      files: {},\n      // Contains result data from Transloadit.\n      results: [],\n    })\n\n    // We cannot cancel individual files because Assemblies tend to contain many files.\n    const { capabilities } = this.uppy.getState()\n    this.uppy.setState({\n      capabilities: {\n        ...capabilities,\n        individualCancellation: false,\n      },\n    })\n  }\n\n  uninstall () {\n    this.uppy.removePreProcessor(this.#prepareUpload)\n    this.uppy.removePostProcessor(this.#afterUpload)\n    this.uppy.off('error', this.#onError)\n\n    if (this.opts.importFromUploadURLs) {\n      this.uppy.off('upload-success', this.#onFileUploadURLAvailable)\n    }\n\n    const { capabilities } = this.uppy.getState()\n    this.uppy.setState({\n      capabilities: {\n        ...capabilities,\n        individualCancellation: true,\n      },\n    })\n  }\n\n  getAssembly (id) {\n    const { assemblies } = this.getPluginState()\n    return assemblies[id]\n  }\n\n  getAssemblyFiles (assemblyID) {\n    return this.uppy.getFiles().filter((file) => {\n      return file && file.transloadit && file.transloadit.assembly === assemblyID\n    })\n  }\n}\n\nmodule.exports.COMPANION = COMPANION\nmodule.exports.COMPANION_PATTERN = ALLOWED_COMPANION_PATTERN\n"]}